---
title: Jubjub
layout: math
---

# Jubjub

[Jubjub](https://z.cash/technology/jubjub.html)是Zerocash团队为了提高Zerocash的效率开发的一项新技术。

## 技术细节

Jubjub是有限域BLS12-381上的Edward椭圆曲线。

$-x^2+y^2=1+dx^2y^2$

其中$d=-(10240/10241)$。它是一个 **twisted Edward曲线**。

* Twisted Edward曲线，就是Edward曲线的Twist。
* 一条域K上的曲线E，它的twist和它在K上不同构，但在K的扩域上同构。比如E是$y^2=x^3+a\_2x^2+a\_4x+a\_6$，它的twist是$dy^2=x^3+a\_2x^2+a\_4x+a\_6$，这里$d$是K中没有平方根的元素。将$d$的平方根包含进K得到K的二次扩域$K(\sqrt{d})$。
* Twisted Edward曲线有两个参数$a,d$，方程为$ax^2+y^2=1+dx^2y^2$。当$a$为1时，这就是条普通Edward曲线。所以说Twisted Edward曲线可以看做Edward曲线的扩展。

这种曲线有一个好处就是倍点运算和涉及到零点的运算不用特殊处理。

利用加法和乘法，使用五个二次限制条件，可以表示出一个条件加的限制条件：当比特$b$为0时，$(x\_3,y\_3)=(x\_1,y\_1)$，否则$(x\_3,y\_3)=(x\_1,y\_1)+(x\_2,y\_2)$。

利用这个条件加，进一步实现标量积限制条件。对251比特的标量，大约需要1506个乘法门。

这个实现方法还不够好。考虑windowed exponentiation。

* Window exponentiation可以看做基本的“加倍加法”的一个扩展。首先，预计算$x$的幂，从$x^1$到$x^{2^k-1}$，这里$k$是窗口大小。从左往右滑动窗口，每走一步将结果平方，直到碰到一个非零的比特，这时候窗口会覆盖$k$个比特，对应一个$x$的幂，将结果平方$k$次，把这个幂乘到结果上，窗口直接跳$k$步。

但目前这个实现方法中，windowed exponentiation比较昂贵。要解决这个问题，首先，实现一个查表机制，比如有四个常数$(c\_0,c\_1,c\_2,c\_3)$，两个比特$b\_0$和$b\_1$，怎样让另一个常数$r$在不同的$b\_0$和$b\_1$的赋值下分别等于这个四个常数呢？观察下面这个式子

$(b\_0)\times(-c\_0+c\_0b\_1+c\_1-c\_1b\_1-c\_2b\_1+c\_3b\_1)=(r-c\_0+c\_0b\_1-c\_2b\_1)$

当$b\_0$和$b\_1$分别独立取$0$或$1$时，$r$正好遍历四个常数。

* 这个式子怎么想起来的？先不考虑$b\_0$，用$b\_1$来决定$c\_0$和$c\_2$，这很简单，两个数一个乘以$b\_1$，一个乘以$1-b\_1$，加起来即可，$r=c\_0(1-b\_1)+c\_2b\_1$。然后考虑当$b\_0=1$时，对$c\_1$和$c\_3$来一个类似的$c\_1(1-b\_1)+c\_3b\_1$，然后把$c\_0$和$c\_2$消掉。这就得到了上式。
* 很容易想到，如果再来一个$b_2$，就要把这个式子重复三遍。因此门数和比特个数是成指数增加的（和常数个数也是，底数为3/2）。

利用这个查表机制，实现windowed exponentiation，通过选取合适的window大小，可以将标量积中每个比特所需的门数缩小到4.2倍。

这样，就可以考虑把椭圆曲线运算编成电路，用zk-SNARK实现。

zk-SNARK用的circuit是算数（arithmetic）的，但SHA256以比特运算为主，一个比特要占用一个本来可以容纳一个域元素的输入输出，相当浪费，也导致zerocash的电路门过多，效率低下。有了椭圆曲线，就可以把SHA256承诺换成Pedersen承诺。另外，还可以用椭圆曲线构造抗碰撞哈希。

* 用椭圆曲线构造抗碰撞哈希：随机选取一组$n$个不同的生成元$g\_1,\cdots,g\_n$。对$n$比特的消息$b\_1,\cdots,b\_n$，哈希定义为所有$g\_i^{b\_i}$的乘积（也就是把其中所有对应位置为1的生成元乘在一起）。
* Pedersen承诺：取两个生成元$g$和$h$，陷门$r$，对消息$x$的陷门承诺为$c=g^xh^r$。

目前作者对Jubjub给了一个prototype，用Rust写的。

总结：Jubjub就是把椭圆曲线高效地放进了zk-SNARK里，采用一种特殊的Twisted Edward曲线；再把Zerocash中用到SHA256的地方全都用椭圆曲线替换。
