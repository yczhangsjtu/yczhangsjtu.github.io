---
title: Linux权限管理
---

# Linux权限管理

Linux是一个多用户系统，为了防止不同用户之间相互干扰（窃取隐私，破坏等等），系统对每个文件都做了权限限制。

就好比一群人围坐在一张大桌子上学习，每个人都带了一本书过来。一本书是谁带来的，它就属于谁。Linux系统下，每个文件都一定有一个所有者。

【实验】把一个用户删掉，属于这个用户的文件会属于谁？

* 属于一个没有在系统里注册的UID。它在系统里的地位相当于属于一个永远无法操作的用户。

每个文件有三种操作，读取，修改，执行。每个用户对某一文件的权限就由他能否做这三个操作来定义，比如对这个文件他可以读，但不能写，也不能执行。这个文件的权限管理中，用三个比特来记录。不过，如果这个文件属于用户自己，他其实可以随便修改自己对这个文件的权限。对于他自己的文件，他关闭某些权限仅仅是为了防止自己误做什么操作。

一般来说，大家都在一起学习，借别人的书看看属于再正常不过的行为，不过不要在人家的书上做笔记，这就是教养问题了。Linux下，为了能够把文件（书）借给别人看，让别人对自己的文件有一定的操作权限，又用专门的三个比特来存储“别人”（others）的权限。比如，在别人的权限中，只设置了读比特，没有设置写比特，那么别人对这个文件就只能读，不能写。

注意，Linux系统下有文件夹的概念，所以文件夹的权限就比较特殊了。比如cd进一个文件夹需要它的执行权限，而ls一个文件夹需要的是读权限。删掉文件夹里的一个文件，需要对它的写权限。所以，即使对一个文件没有任何操作权限，也有可能删掉它，只要你对这个文件夹有写的权限。

有些时候你只想把书借给特定的人。就好比这群人组成了好几个小组，小组之间进行比赛，小组之间的资料完全不能共享。这时候，仅仅一个“别人”权限设置就不够了，因为你要么把所有人挡在外面，要么允许所有人读你的文件。为了应对这种情况，Linux添加了组的概念。每个文件都有一个所属的人，和一个所属的组。然后再来三个比特，规定这个文件的组权限，就是说属于这个组的用户能够对这个文件做些什么操作。

一个人有可能加入多个组。比如说，你组队参加比赛，你所属的队伍是你属于的一个组。但你还有三个铁哥们，你们四个人属于一个小圈子，只可惜他们并没有和你分到一个比赛队伍里。Linux里的组也可以相互交叉，也可以一个共同的人都没有，还可以完全重合，一点限制都没有。但你只能在一个组里分享属于这个组的文件。不过，这个文件属于你，你可以随便修改它属于哪个组。所以，本来一个文件你打算要在队伍里分享的，你可以改主意，拿到你的小团伙里分享去了。当然，你不能把一个文件的组修改成你不属于的组（胳膊肘往外拐）。但是，root可以！也就是说，你可以拥有一个文件，而你不属于的某个组也拥有它。不过，组拥有的权力没有你大，你可以随时把组修改回来。

当你新建一个文件的时候，这个文件当然是属于你的，但它属于哪个组呢？Linux给每个用户设定了一个默认组，新建的文件自动属于这个组。

于是，一个文件的权限规定就完整了，它属于谁，属于哪个组，“自己”的权限，“组”的权限，“别人”的权限。它对每一方的权限都用三个比特来表示，三个比特只能表示8个数字，所以三个0-7的数字就可以把它的权限表示出来。比如755，就是自己可读可写可执行，组内和其他人都不能写。

最后，是运行时的权限问题。一个脚本文件可以没有运行权限，但不妨碍你运行它，比如python脚本，就算你没有运行权限，只要你有读的权限，你就可以用python读它然后运行（但你不能用点杠的方式运行它，这需要它自己的运行权限）。另外，系统里大部分程序（就算是你自己安装的程序，只要你是用sudo安装的）都属于root，它只是借给你用，但你用root的程序去修改root的文件可不可以呢？不可以！虽然一个可执行文件属于另一个用户，给你了执行权限，你执行它时，它还是代表你（你用vim打开/etc下的文件，不用sudo的话，就只能只读）。可是如果这个程序需要写到一个文件，这个文件只能你自己写，那这个程序就算别人有运行权限，也不能运行（想象passwd让没有sudo权限的用户改密码该怎么办吧），这个时候，你可能想让别人运行这个程序的时候，以你（文件的拥有者）的名义运行。于是Linux还给文件增加了一个SUID比特，这个比特设置了，别人运行程序的时候就代表你了。类似地，文件还有一个SGID比特，别人运行这个文件的时候，拥有这个文件所属的组的权限。对文件夹来说，设置了SGID比特后，文件夹下新建的文件的组都自动设置为这个文件夹的组（一般情况下，是设置为这个用户的默认组）。

SUID比特是一个比较要命的问题，所谓的提权攻击靠的就是它了。把自己的一个可执行程序设置SGID比特是非常危险的，因为别人可以借助它来以你的名义做事，如果你真要这么做，就先保证你的程序逻辑没有任何问题，把能做的事情死死限制在你希望它做的事情上。一个相对安全的做法是在程序运行过程中，到需要的时候才修改SUID比特，调用`setuid`过程，不需要的时候赶紧回去，这样出问题的概率更小。

SUID比特，SGID比特，再加上一个STICKY比特，又构成了一个0-7的数字。这个数字放在rwx权限的最前面，完整的权限描述就是四位数。一般设置权限的时候，这个数字可以忽略。

* STICKY比特：一个文件夹设置了STICKY比特的话，就算你对它有写权限，你也不能删除里面其他人的文件。一般Linux系统的/tmp文件夹会设STICKY比特，因为这个文件夹是公用的，它需要给你写的权限，却不能让你随便删别人的东西。
